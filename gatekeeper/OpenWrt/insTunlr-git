scriptLocation='https://raw.github.com/FriedZombie/tunlrUpdater/master/gatekeeper/gatekeeperUpdate'
hotplugLocation='https://raw.github.com/FriedZombie/tunlrUpdater/master/gatekeeper/OpenWrt/80-gatekeeperUpdate'

tScr=`wget --no-check-certificate -O - "${scriptLocation}"` || exit 1
hScr=`wget --no-check-certificate -O - "${hotplugLocation}"` || exit 1

echo ""
echo $'\nFill out the credentials for tunlr gatekeeper.\nThey will be stored locally in the script\n'

read -r -p $'Username/email\t: ' user
read -r -p $'Password\t: ' pass
isOk "Are the credentials correct?"

echo $'\nStoring the modified script to:'
echo "/sbin/gatekeeperUpdate"

echo "${tScr}" | sed "s/user@example\.com/${user}/;s/pass12345/${pass}/;
  s/logCmdErr=''/logCmdErr='logger -t tunlr -p daemon.error'/;
  s/logCmd=''/logCmd='logger -t tunlr -p daemon.info'/;
  s/'wget'/'${agent}'/" > /sbin/gatekeeperUpdate

chmod +x /sbin/gatekeeperUpdate

if [ -d /etc/hotplug.d/iface ]; then
	echo "the /etc/hotplug.d/iface directory exists"
	echo "The hotplug script calls gatekeeperUpdate when the interface"
	echo "changes ip address or on reboot"
	while true; do
		isOk "Create hotplug script?"
		echo ""
		echo "If you press enter the dedault interface wan is selected"
		read -r -p $'interface name?\t: ' iface
		[ -z "$iface" ] && iface="wan"
		uci get network."${iface}" 2>&1 > /dev/null
		if [ $? -eq 0 ]; then
			echo 'storing the modified hotplug script to:'
			echo '/etc/hotplug.d/iface/80-gatekeeperUpdate'
			echo "${hScr}" | sed 's/"wan"/"'"${iface}"'"/' > /etc/hotplug.d/iface/80-gatekeeperUpdate
			break;
		else
			echo $'\nInterface does not exist!'
		fi
	done
else
	echo "the /etc/hotplug.d/iface directory doesn't exist"
	echo "skipping the hotplug script"
fi
